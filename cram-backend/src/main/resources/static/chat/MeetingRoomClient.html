<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Socket.IO WebRTC</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input { margin-bottom: 10px; width: 300px; padding: 5px; }
        video { width: 300px; height: 200px; margin: 10px; background: black; }
    </style>
</head>
<body>
<h1>Socket.IO WebRTC Room</h1>

<label for="email-input">Email (ì˜ˆ: user1@example.com)</label>
<input id="email-input" placeholder="ì´ë©”ì¼ ì…ë ¥" value="user1@example.com">

<label for="group-input">Group ID (ìˆ«ì ì…ë ¥)</label>
<input id="group-input" placeholder="ê·¸ë£¹ ID ì…ë ¥" type="number" value="1">

<label for="meeting-room-input">Meeting Room ID (ìˆ«ì ì…ë ¥)</label>
<input id="meeting-room-input" placeholder="ë¯¸íŒ…ë£¸ ID ì…ë ¥" type="number" value="1">

<label for="peer-id-input">Peer ID (1,2,3...)</label>
<input id="peer-id-input" placeholder="Peer ID ì…ë ¥" value="1">
<div id="chat-ui" style="display: none; margin-top: 20px;">
    <div id="chat-box" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendTextMessage()">ì „ì†¡</button>
</div>
<button onclick="connectWithEmail()">1. í† í° ë°œê¸‰</button>
<button onclick="connection()">2. ì„œë²„ ì—°ê²° ë° ì…ì¥</button>
<button onclick="getWebrtcJoin()">2. í™”ìƒìŒì„±ì±„ë„ ì…ì¥</button>

<h3>ë¡œì»¬ ë¹„ë””ì˜¤</h3>
<video id="local_video" autoplay playsinline muted></video>
<h3>ì›ê²© ì°¸ê°€ì ë¹„ë””ì˜¤</h3>
<div id="remote-videos"></div>

<script>
    let socket;
    let myToken, localUserName, groupId, meetingRoomId, email;
    const peerConnections = new Map();
    const participants = new Set();
    let localStream;

    async function connectWithEmail() {
        email = document.getElementById("email-input").value.trim();
        groupId = document.getElementById("group-input").value.trim();
        meetingRoomId = document.getElementById("meeting-room-input").value.trim();
        localUserName = document.getElementById("peer-id-input").value.trim();

        if (!email || !groupId || !meetingRoomId || !localUserName) {
            alert("ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {



            const response = await fetch(`/api/token?email=${email}&groupId=${groupId}`);
            const data = await response.json();
            myToken = data.token;
            console.log("[DEBUG] í† í° ë°œê¸‰ ì„±ê³µ:", myToken);

            const socketTicketResponse = await fetch(`/api/v1/groups/${groupId}/meeting-rooms/${meetingRoomId}/join`, {
                method: 'GET',  // GET ìš”ì²­
                headers: {
                    'Authorization': `Bearer ${myToken}`  // Authorization í—¤ë”ì— í† í° í¬í•¨
                }
            });

            const json = await socketTicketResponse.json();

            console.log(json);

            myToken = json.data.meetingRoomTicket;
            meetingRoomId = json.data.meetingRoomId;

            console.log("[DEBUG] í† í° ë°œê¸‰ ì„±ê³µ:", myToken);
        } catch (e) {
            console.error("[ERROR] í† í° ë°œê¸‰ ì‹¤íŒ¨:", e);
            alert("í† í° ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    function getWebrtcJoin() {
        socket.emit("join", { groupId }, async (...ack) => {

            const [type, payload] = ack;

            const data = ack || {};
            console.log("[DEBUG] ë°›ì€ peerList:",payload);
            const peerList = (payload.peerList || []).map(peer => peer.userId);


            console.log("[DEBUG] ë°›ì€ peerList:add",peerList);
            for (const userId of peerList || []) {
                if (userId !== localUserName) {
                    console.log("[DEBUG] peerList:add", userId);
                    participants.add(userId);
                    await createPeerConnection(userId);
                }
            }
        });

        socket.emit("newPeer", { userId: localUserName });
    }

    function connection() {
        if (!myToken) {
            alert("ë¨¼ì € í† í°ì„ ë°œê¸‰ ë°›ì•„ì£¼ì„¸ìš”.");
            return;
        }


        socket = io("ws://175.117.82.139/ws/v1/meetingRoom", {
            path: "/socket.io",
            query: { token: myToken, meetingRoomId: Number(meetingRoomId) },
            transports: ["websocket"]
        });

        // socket = io("ws://223.130.146.25/ws/v1/meetingRoom", {
        //     path: "/socket.io",
        //     query: { token: myToken, meetingRoomId: Number(meetingRoomId) },
        //     transports: ["websocket"]
        // });

        socket.on("connect", async () => {
            console.log("[DEBUG] Socket ì—°ê²° ì™„ë£Œ");
            document.getElementById("chat-ui").style.display = "block";

        });

        socket.on("newPeer", async ({ userId }) => {
            console.log("[DEBUG] ìƒˆ í”¼ì–´ ë“±ì¥:", userId);
            if (userId !== localUserName) {
                participants.add(userId);
                await createPeerConnection(userId);
                await makeOffer(userId);
            }
        });

        socket.onAny((event, ...args) => {
            console.log(`[onAny] ìˆ˜ì‹  ì´ë²¤íŠ¸ëª…: ${event}`);
            console.log(`[onAny] ë°ì´í„°:`, args);
        });

        socket.on("peerList", async (data) => {
            console.log(data);
        });

        socket.on("offer", async ({ userId, sdp }) => {
            console.log("[DEBUG] offer ìˆ˜ì‹  from:", userId);
            console.log("[DEBUG] offer ìˆ˜ì‹  ë°›ì€ sdp:", sdp);
            await handleOffer(userId, sdp);
        });

        socket.on("answer", async ({ userId, sdp }) => {
            console.log("[DEBUG] answer ìˆ˜ì‹  from:", userId);
            await handleAnswer(userId, sdp);
        });

        socket.on("iceCandidate", async ({ userId, candidate }) => {
            console.log("[DEBUG] ICE ìˆ˜ì‹  from:", userId);
            await handleIceCandidate(userId, candidate);
        });
        socket.on("message", (data) => {
            console.log("ğŸ“© ìˆ˜ì‹ :", data);
            displayMessage(data);
        });
        socket.on("disconnect", () => {
            console.log("ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨");
            document.getElementById("chat-ui").style.display = "none";
        });
    }

    async function createPeerConnection(peerId) {
        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        peerConnections.set(peerId, pc);

        pc.onicecandidate = e => {
            if (e.candidate) {
                console.log("[DEBUG] ICE í›„ë³´ ì „ì†¡:", e.candidate);
                socket.emit("iceCandidate", {
                    userId: peerId,
                    candidate: e.candidate
                });
            }
        };

        pc.ontrack = e => {
            console.log("[DEBUG] track ìˆ˜ì‹  from:", peerId);
            let video = document.getElementById(`remote-${peerId}`);
            if (!video) {
                video = document.createElement("video");
                video.id = `remote-${peerId}`;
                video.autoplay = true;
                video.playsInline = true;
                document.getElementById("remote-videos").appendChild(video);
            }
            video.srcObject = e.streams[0];
        };

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    async function makeOffer(peerId) {
        const pc = peerConnections.get(peerId);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        console.log("[DEBUG] offer ì „ì†¡ to:", peerId);
        socket.emit("offer", { userId: peerId, sdp: offer });
    }

    async function handleOffer(from, sdp) {
        const pc = peerConnections.get(from);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        console.log("[DEBUG] answer ì „ì†¡ to:", from);
        socket.emit("answer", { userId: from, sdp : answer });
    }

    async function handleAnswer(from, sdp) {
        const pc = peerConnections.get(from);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    }

    async function handleIceCandidate(from, candidate) {
        const pc = peerConnections.get(from);
        if (pc && candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
    }

    async function startLocalStream() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById("local_video").srcObject = localStream;
            console.log("[DEBUG] ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì„±ê³µ");
        } catch (e) {
            console.error("[ERROR] ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨:", e);
            alert("ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
        }
    }

    function sendTextMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message || !socket || !socket.connected) return;

        const tempId = Math.random().toString(36).substring(2, 8);

        const payload = {
            type: "text",
            message: message,
            image: null,
            tempId: tempId
        };

        socket.emit("message", payload, (ack) => {
            console.log("âœ… ì„œë²„ ì‘ë‹µ:", ack);
        });

        input.value = "";
    }

    function displayMessage(data) {
        const chatBox = document.getElementById("chat-box");

        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-message";
        msgDiv.style.marginBottom = "10px";

        const profileHtml = `
            <img src="${data.senderProfileUrl || ''}" style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 5px;">
            <strong>${data.senderName}</strong>
            <small style="color: gray;">${new Date(data.createdAt).toLocaleString()}</small>
        `;

        let contentHtml = "";
        if (data.messageType === "text") {
            contentHtml = `<p>${data.message}</p>`;
        } else if (data.messageType === "image") {
            contentHtml = `<img src="${data.imageUrl}" style="max-width: 200px;">`;
        }

        msgDiv.innerHTML = `${profileHtml}<br>${contentHtml}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    window.onload = startLocalStream;
</script>
</body>
</html>
