<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Socket.IO Chat</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
<h2>ì±„íŒ… ì ‘ì†: ì´ë©”ì¼ë¡œ í† í° ë°œê¸‰ í›„ ê·¸ë£¹ IDë¡œ ì ‘ì† (user1~user10@example.com)</h2>

<label for="email-input">EMAIL</label>
<input type="email" id="email-input" placeholder="ì´ë©”ì¼" value="user1@example.com"/>
<label for="group-input">GROUP_ID</label>
<input type="number" id="group-input" placeholder="ê·¸ë£¹ ID" min="1" value="1"/>
<button onclick="connectWithEmail()">ì ‘ì†í•˜ê¸°</button>

<div id="chat-ui" style="display: none; margin-top: 20px;">
    <div id="chat-box" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>
    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendTextMessage()">ì „ì†¡</button>
</div>

<script>
    let socket = null;

    async function connectWithEmail() {
        disconnectSocket();
        const email = document.getElementById("email-input").value.trim();
        const groupId = document.getElementById("group-input").value.trim();

        if (!email || !groupId) {
            alert("ì´ë©”ì¼ê³¼ ê·¸ë£¹ IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            const response = await fetch(`/api/token?email=${email}&groupId=${groupId}`);
            if (!response.ok) {
                alert("ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const { token } = await response.json();

            const socketTicketResponse = await fetch(`/api/v1/groups/${groupId}/join`, {
                method: 'GET',  // GET ìš”ì²­
                headers: {
                    'Authorization': `Bearer ${token}`  // Authorization í—¤ë”ì— í† í° í¬í•¨
                }
            });

            const json = await socketTicketResponse.json();

            const ticket = json.data.groupChatTicket;

            // Socket.IO ì—°ê²°

            socket = io("ws://175.117.82.139/ws/v1/groupchat", {
                query: {
                    token:ticket,
                    groupId
                },
                transports: ["websocket"]
            });

            // socket = io("ws://223.130.146.25/ws/v1/groupchat", {
            //     query: {
            //         token:ticket,
            //         groupId
            //     },
            //     transports: ["websocket"]
            // });



            socket.on("connect", () => {
                console.log("âœ… Socket.IO ì—°ê²°ë¨");
                document.getElementById("chat-ui").style.display = "block";
                socket.emit("join", {
                    groupId: groupId,
                    timestamp: new Date().toISOString()
                });
            });

            socket.on("disconnect", () => {
                console.log("ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨");
                document.getElementById("chat-ui").style.display = "none";
            });

            socket.on("connect_error", (err) => {
                console.error("âŒ ì—°ê²° ì‹¤íŒ¨:", err.message);
            });

            socket.on("message", (data) => {
                console.log("ğŸ“© ìˆ˜ì‹ :", data);
                displayMessage(data);
            });

            socket.on("updateMessageId", (data) => {
                console.log("ğŸ“© ìˆ˜ì‹ :", data);

            });

        } catch (err) {
            console.error("í† í° ìš”ì²­ ì‹¤íŒ¨:", err);
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    function sendTextMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message || !socket || !socket.connected) return;

        const tempId = Math.random().toString(36).substring(2, 8);

        console.log("wjsthd")
        const payload = {
            type: "text",
            message: message,
            image: null,
            tempId: tempId
        };

        socket.emit("message", payload, (ack) => {
            console.log("âœ… ì„œë²„ ì‘ë‹µ:", ack);
        });



        input.value = "";
    }

    function displayMessage(data) {
        const chatBox = document.getElementById("chat-box");

        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-message";
        msgDiv.style.marginBottom = "10px";

        const profileHtml = `
      <img src="${data.senderProfileUrl || ''}" style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 5px;">
      <strong>${data.senderName}</strong>
      <small style="color: gray;">${new Date(data.createdAt).toLocaleString()}</small>
    `;

        let contentHtml = "";
        if (data.messageType === "text") {
            contentHtml = `<p>${data.message}</p>`;
        } else if (data.messageType === "image") {
            contentHtml = `<img src="${data.imageUrl}" style="max-width: 200px;">`;
        }

        msgDiv.innerHTML = `${profileHtml}<br>${contentHtml}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function disconnectSocket() {
        if (socket && socket.connected) {
            socket.disconnect();
            console.log("ğŸ”Œ ìˆ˜ë™ ì—°ê²° ì¢…ë£Œ");
            document.getElementById("chat-ui").style.display = "none";
        }
    }
</script>
</body>
</html>
